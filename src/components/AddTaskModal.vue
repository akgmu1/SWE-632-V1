<script setup lang="ts">
import { DataManager } from '@/data'
import { dateToYYYYMMDD, dateTrim, randomColor } from '@/helper'
import {
  categoryManager,
  DEFAULT_CATEGORY,
  META_ADD_NEW_CATEGORY,
  type Category,
} from '@/schemas/category'
import type { CreateTask } from '@/schemas/task'
import { computed, ref, type Ref } from 'vue'
import z from 'zod'
import CategoryColor from './CategoryColor.vue'
import ConfirmationModal from './ConfirmationModal.vue'

interface Emits {
  (e: 'addTask', task: CreateTask): void
}
const emits = defineEmits<Emits>()

const inputRef: Ref<HTMLInputElement | null> = ref(null)

const title = ref('')
const dueDate = ref(new Date())
const rememberOptions = ref(true)

const rememberedOptionsSchema = z.object({
  dueDate: z.coerce.date(),
  category: z.number(),
})

const rememberedOptions = new DataManager(rememberedOptionsSchema, 'add-task-remembered-options')

const categories = ref<Category[]>(categoryManager.all())
const selectedCategory = ref<number>(0)
const newCategoryName = ref('')
const newCategoryColor = ref(randomColor())
const currentCategory = computed(() => {
  return categoryManager.findBy('id', selectedCategory.value)!
})

function loadRememberedOptions() {
  const x = rememberedOptions.load()
  if (x === undefined) {
    return
  }
  if (categoryManager.findBy('id', x.category) === undefined) {
    x.category = DEFAULT_CATEGORY
  }
  dueDate.value = x.dueDate
  selectedCategory.value = x.category
}

function saveRememberedOptions() {
  if (!rememberOptions.value) return
  rememberedOptions.save({
    dueDate: dateTrim(dueDate.value),
    category: selectedCategory.value, // TODO: Make sure not save META add
  })
}

const modalRef: Ref<InstanceType<typeof ConfirmationModal> | null> = ref(null)

defineExpose({
  showModal: () => {
    categories.value = categoryManager.all()
    selectedCategory.value = DEFAULT_CATEGORY
    newCategoryName.value = ''
    newCategoryColor.value = randomColor()

    loadRememberedOptions()

    modalRef.value!.showModal()
    setTimeout(() => inputRef.value?.focus(), 0)
  },
  close: () => modalRef.value!.close(),
})

const isAddingNewCategory = computed(() => selectedCategory.value === META_ADD_NEW_CATEGORY)

function onCategoryChange(val: number) {
  selectedCategory.value = val
  if (val !== META_ADD_NEW_CATEGORY) {
    newCategoryName.value = ''
    newCategoryColor.value = randomColor()
  }
}

const canConfirm = computed(() => {
  if (!title.value.trim()) return false
  if (isAddingNewCategory.value) {
    return newCategoryName.value.trim().length > 0
  }
  return true
})

function onConfirm() {
  if (!canConfirm.value) return

  let finalCategory: number = DEFAULT_CATEGORY

  if (isAddingNewCategory.value) {
    const newName = newCategoryName.value.trim()
    const exists = categoryManager.findBy('name', newName)
    if (!exists) {
      finalCategory = categoryManager.add({
        name: newName,
        color: newCategoryColor.value,
      })
    }
    selectedCategory.value = finalCategory
  } else {
    finalCategory = selectedCategory.value
  }

  const text = title.value.trim()

  emits('addTask', {
    title: text,
    completed: false,
    dueDate: dueDate.value,
    category: finalCategory,
  })

  saveRememberedOptions()

  title.value = ''

  if (!rememberOptions.value) {
    dueDate.value = new Date()
    selectedCategory.value = DEFAULT_CATEGORY
  }

  newCategoryName.value = ''
  newCategoryColor.value = randomColor()
}
</script>

<template>
  <ConfirmationModal
    ref="modalRef"
    title="Create Task"
    @confirm="onConfirm"
    :should-close="canConfirm"
    :positive="true"
  >
    <div class="w-full">
      <div class="flex flex-col gap-4">
        <div class="flex flex-col gap-4 sm:flex-row">
          <input
            ref="inputRef"
            v-model="title"
            type="text"
            placeholder="Title"
            class="input-bordered input w-full"
            @keyup.enter="onConfirm"
          />

          <input
            type="date"
            :value="dateToYYYYMMDD(dueDate)"
            @input="
              dueDate = dateTrim(
                ($event.target as HTMLInputElement).valueAsDate ?? new Date(),
                true,
              )
            "
            class="input-bordered input w-full"
          />
        </div>

        <div class="flex items-center gap-3">
          <CategoryColor :category="currentCategory" />

          <select
            class="select-bordered select w-full"
            :value="selectedCategory"
            @change="onCategoryChange(Number(($event.target as HTMLSelectElement).value))"
          >
            <option value="" disabled>Selected Category (optional)</option>
            <option v-for="c in categories" :key="c.id" :value="c.id">
              <div v-if="c.id === META_ADD_NEW_CATEGORY">+ Add new categoryâ€¦</div>
              <div v-else>{{ c.name }}</div>
            </option>
          </select>
        </div>
        <div v-if="isAddingNewCategory" class="flex items-center gap-3">
          <CategoryColor :color="newCategoryColor" />
          <input
            v-model="newCategoryName"
            type="text"
            placeholder="New category name"
            class="input-bordered input w-full"
            @keyup.enter="onConfirm"
          />
        </div>

        <!-- Remember Options -->
        <label class="flex cursor-pointer items-center gap-2">
          <input type="checkbox" class="checkbox" v-model="rememberOptions" />
          <span>Remember Options</span>
        </label>
      </div>
    </div>

    <template #confirm>Create</template>
  </ConfirmationModal>
</template>
