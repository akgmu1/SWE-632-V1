<script setup lang="ts">
import AddTaskModal from '@/components/AddTaskModal.vue'
import ConfirmationModal from '@/components/ConfirmationModal.vue'
import LogTimeModal from '@/components/LogTimeModal.vue'
import ManageCategoriesModal from '@/components/ManageCategoriesModal.vue'
import SearchBar from '@/components/SearchBar.vue'
import TaskItem from '@/components/TaskItem.vue'
import ToolTip from '@/components/ToolTip.vue'
import UpdateTaskModal from '@/components/UpdateTaskModal.vue'
import { HomeState, ToolTipDirection } from '@/enums'
import { categoryManager, PERM_CATEGORIES, type Category } from '@/schemas/category'
import { deletedTaskManager, taskManager, type CreateTask, type Task } from '@/schemas/task'
import { timeEntryManager, type CreateTimeEntry } from '@/schemas/timeEntry'
import { ArchiveBoxIcon, PencilSquareIcon } from '@heroicons/vue/24/outline'
import { PlusIcon, TrashIcon, XMarkIcon } from '@heroicons/vue/24/solid'
import { computed, ref, type Ref } from 'vue'

const logTimeModalRef: Ref<InstanceType<typeof LogTimeModal> | null> = ref(null)

function openLogTime(task: Task) {
  logTimeModalRef.value!.showModal(task)
}

function logTime(entry: CreateTimeEntry) {
  timeEntryManager.add(entry)
  refreshTasks()
}

const homeState: Ref<HomeState> = ref(HomeState.Default)

const categories: Ref<Category[]> = ref(categoryManager.all())
const tasks: Ref<Task[]> = ref(taskManager.all())
const deletedTasks: Ref<Task[]> = ref(deletedTaskManager.all())

const q = computed(() => search.value.trim().toLowerCase())
const search = ref('')

const activeTasks = computed(() =>
  tasks.value.filter((t) => !t.completed && (!q.value || t.title.toLowerCase().includes(q.value))),
)

const completedTasks = computed(() =>
  tasks.value.filter((t) => t.completed && (!q.value || t.title.toLowerCase().includes(q.value))),
)

const filteredDeletedTasks = computed(() =>
  deletedTasks.value.filter((t) => !q.value || t.title.toLowerCase().includes(q.value)),
)

function refreshTasks() {
  tasks.value = [...taskManager.all()]
  deletedTasks.value = [...deletedTaskManager.all()]
  categories.value = [...categoryManager.all()]
}

function toggleTask(id: number, completed: boolean) {
  taskManager.updateBy('id', id, { completed })
  refreshTasks()
}

const selectedTask: Ref<Task | undefined> = ref(undefined)

const confirmDeleteModalRef: Ref<InstanceType<typeof ConfirmationModal> | null> = ref(null)
function confirmDelete() {
  deletedTaskManager.add(selectedTask.value!)
  taskManager.removeBy('id', selectedTask.value!.id)
  refreshTasks()
}

const confirmRecoverModalRef: Ref<InstanceType<typeof ConfirmationModal> | null> = ref(null)
function confirmRecover() {
  taskManager.insert(selectedTask.value!)
  deletedTaskManager.removeBy('id', selectedTask.value!.id)
  refreshTasks()
}

const updateModalRef: Ref<InstanceType<typeof UpdateTaskModal> | null> = ref(null)
function updateTask(task: Task, subtask: boolean) {
  taskManager.updateBy('id', task.id, task)
  refreshTasks()
}

function taskClicked(id: number, isDeleted: boolean) {
  if (isDeleted) {
    switch (homeState.value) {
      case HomeState.Delete: {
        homeState.value = HomeState.Default
        selectedTask.value = deletedTaskManager.findBy('id', id)
        if (selectedTask.value !== undefined) {
          confirmRecoverModalRef.value!.showModal()
        }
        break
      }
    }
  } else {
    switch (homeState.value) {
      case HomeState.Update: {
        homeState.value = HomeState.Default
        selectedTask.value = taskManager.findBy('id', id)
        if (selectedTask.value !== undefined) {
          updateModalRef.value!.showModal(selectedTask.value)
        }
        break
      }
      case HomeState.Delete: {
        homeState.value = HomeState.Default
        selectedTask.value = taskManager.findBy('id', id)
        if (selectedTask.value !== undefined) {
          confirmDeleteModalRef.value!.showModal()
        }
        break
      }
    }
  }
}

const addTaskModalRef: Ref<InstanceType<typeof AddTaskModal> | null> = ref(null)

function addTask(task: CreateTask) {
  taskManager.add(task)
  refreshTasks()
}

function addButton() {
  addTaskModalRef.value!.showModal()
}

const confirmClearRecentlyDeleteModalRef: Ref<InstanceType<typeof ConfirmationModal> | null> =
  ref(null)
function clearRecentlyDeletedTasks() {
  deletedTaskManager.reset()
  refreshTasks()
}

const manageCategoriesModalRef: Ref<InstanceType<typeof ManageCategoriesModal> | null> = ref(null)
function updateCategory(category: Category) {
  categoryManager.updateBy('id', category.id, category)
  refreshTasks()
}

function deleteCategory(category: Category) {
  categoryManager.removeBy('id', category.id)
  refreshTasks()
}
</script>

<template>
  <main class="container mx-auto py-4">
    <div class="mb-4 flex items-center justify-between">
      <div class="text-2xl font-semibold">To Do List</div>

      <div v-if="homeState == HomeState.Default" class="flex items-center gap-2">
        <ToolTip :direction="ToolTipDirection.Bottom" tip="Create">
          <button class="btn btn-circle btn-success" @click="addButton">
            <PlusIcon class="size-6" />
          </button>
        </ToolTip>

        <ToolTip :direction="ToolTipDirection.Bottom" tip="Edit">
          <button class="btn btn-circle" @click="homeState = HomeState.Update">
            <PencilSquareIcon class="size-6" />
          </button>
        </ToolTip>

        <ToolTip :direction="ToolTipDirection.Bottom" tip="Delete">
          <button class="btn btn-circle btn-error" @click="homeState = HomeState.Delete">
            <TrashIcon class="size-6" />
          </button>
        </ToolTip>
      </div>

      <div v-else>
        <div class="flex items-center gap-2">
          <ToolTip
            v-if="categories.length > PERM_CATEGORIES.length"
            :direction="ToolTipDirection.Bottom"
            tip="Manage Categories"
          >
            <button
              class="btn btn-circle"
              @click="
                () => {
                  homeState = HomeState.Default
                  manageCategoriesModalRef?.showModal()
                }
              "
            >
              <ArchiveBoxIcon class="size-6" />
            </button>
          </ToolTip>
          <ToolTip :direction="ToolTipDirection.Bottom" tip="Cancel">
            <button class="btn btn-circle btn-error" @click="homeState = HomeState.Default">
              <XMarkIcon class="size-6" />
            </button>
          </ToolTip>
        </div>
      </div>
    </div>
    <div class="mb-4 flex justify-center">
      <SearchBar v-model="search" />
    </div>

    <!-- List of tasks working on -->
    <div class="text-xl">Active</div>
    <hr class="my-2" />
    <div class="flex flex-col gap-2">
      <TaskItem
        v-for="task in activeTasks"
        :key="task.id"
        :task="task"
        :home-state="homeState"
        :is-deleted="false"
        @toggle="toggleTask"
        @clicked="taskClicked"
        @logTimeClicked="openLogTime"
      />
    </div>

    <!-- List of completed tasks -->
    <div class="mt-10 text-xl">Completed</div>
    <hr class="my-2" />
    <div class="flex flex-col gap-2">
      <TaskItem
        v-for="task in completedTasks"
        :key="task.id"
        :task="task"
        :home-state="homeState"
        :is-deleted="false"
        @toggle="toggleTask"
        @clicked="taskClicked"
      />
    </div>

    <!-- List of recently deleted tasks -->
    <div v-if="homeState === HomeState.Delete">
      <div class="mt-10 flex justify-between">
        <!-- TODO: mt-3 may not be correct here... -->
        <div class="text-xl" :class="{ 'mt-3': deletedTasks.length > 0 }">Recently Deleted</div>
        <button
          v-if="deletedTasks.length > 0"
          class="btn btn-accent"
          @click="confirmClearRecentlyDeleteModalRef!.showModal"
        >
          Clear
        </button>
      </div>
      <hr class="my-2" />
      <div class="flex flex-col gap-2">
        <TaskItem
          v-for="task in filteredDeletedTasks"
          :key="task.id"
          :task="task"
          :home-state="homeState"
          :is-deleted="true"
          @clicked="taskClicked"
        />
      </div>
    </div>

    <!-- Add a task -->
    <AddTaskModal ref="addTaskModalRef" @add-task="addTask" />

    <!-- Update a task -->
    <UpdateTaskModal ref="updateModalRef" @updateTask="updateTask" />

    <!-- Manage the categories -->
    <ManageCategoriesModal
      ref="manageCategoriesModalRef"
      @updateCategory="updateCategory"
      @delete-category="deleteCategory"
    />

    <!-- Confirming to clear all recently deleted tasks -->
    <ConfirmationModal
      ref="confirmClearRecentlyDeleteModalRef"
      title="Clear Recently Deleted"
      @confirm="clearRecentlyDeletedTasks"
    >
      Are you sure you want to clear the
      <span class="font-bold">{{ deletedTasks.length }}</span> recently deleted
      {{ deletedTasks.length == 1 ? 'task' : 'tasks' }}?
    </ConfirmationModal>

    <!-- Confirming to delete a task -->
    <ConfirmationModal ref="confirmDeleteModalRef" title="Delete Task" @confirm="confirmDelete">
      Are you sure you want to delete task?
      <div class="pt-2 text-center font-bold">"{{ selectedTask?.title }}"</div>
      <template #confirm> Delete </template>
    </ConfirmationModal>

    <!-- Confirming to recover a task -->
    <ConfirmationModal ref="confirmRecoverModalRef" title="Recover Task" @confirm="confirmRecover">
      Are you sure you want to recover task?
      <div class="pt-2 text-center font-bold">"{{ selectedTask?.title }}"</div>
      <template #confirm> Recover </template>
    </ConfirmationModal>
    <LogTimeModal ref="logTimeModalRef" @log-time="logTime" />
  </main>
</template>
